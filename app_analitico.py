
import streamlit as st
import pandas as pd
import joblib
import matplotlib.pyplot as plt
import seaborn as sns
import json


with open("rotulos_traduzidos.json", encoding="utf-8") as f:
    rotulos = json.load(f)

@st.cache_data
def carregar_dados():
    return pd.read_csv("data/Obesity.csv")

@st.cache_resource
def carregar_modelo():
    return joblib.load("models/gb_model (1).joblib")

df = carregar_dados()
modelo = carregar_modelo()

def plot_crosstab(ax, df, row, col, ordem, title=""):
    crosstab = pd.crosstab(df[row], df[col])
    if crosstab.empty:
        st.info(f"üîç N√£o h√° dados suficientes para o gr√°fico: {title}")
        return
    crosstab = crosstab.reindex(ordem, fill_value=0)
    crosstab.plot(kind="bar", ax=ax)
    plt.xticks(rotation=45)


st.sidebar.title("Navega√ß√£o")
pagina = st.sidebar.radio("Ir para:", ["Painel Anal√≠tico"])

if pagina == "Painel Anal√≠tico":
    st.title("Painel Anal√≠tico de Obesidade")
    st.markdown("An√°lise de perfil de obesidade com base nos dados do estudo.")

    st.sidebar.header("Filtros")

    genero_opcoes = list(rotulos["genero_tradutor"].values())
    genero_selecionado = st.sidebar.multiselect("G√™nero", genero_opcoes, default=genero_opcoes)
    genero_valores = [k for k, v in rotulos["genero_tradutor"].items() if v in genero_selecionado]

    idade = st.sidebar.slider("Idade", int(df["Age"].min()), int(df["Age"].max()), (int(df["Age"].min()), int(df["Age"].max())))
    altura = st.sidebar.slider("Altura (m)", float(df["Height"].min()), float(df["Height"].max()), (float(df["Height"].min()), float(df["Height"].max())))
    peso = st.sidebar.slider("Peso (kg)", float(df["Weight"].min()), float(df["Weight"].max()), (float(df["Weight"].min()), float(df["Weight"].max())))

    hist_opcoes = list(rotulos["historico_tradutor"].values())
    hist_selecionado = st.sidebar.multiselect("Hist√≥rico Familiar", hist_opcoes, default=hist_opcoes)
    hist_valores = [k for k, v in rotulos["historico_tradutor"].items() if v in hist_selecionado]

    caec_opcoes = list(rotulos["caec_tradutor"].values())
    caec_selecionado = st.sidebar.multiselect("Lanches Fora de Hora", caec_opcoes, default=caec_opcoes)
    caec_valores = [k for k, v in rotulos["caec_tradutor"].items() if v in caec_selecionado]

    favc_opcoes = list(rotulos["favc_tradutor"].values())
    favc_selecionado = st.sidebar.multiselect("Consumo de Comida Cal√≥rica", favc_opcoes, default=favc_opcoes)
    favc_valores = [k for k, v in rotulos["favc_tradutor"].items() if v in favc_selecionado]

    df_filtrado = df[
        (df["Gender"].isin(genero_valores)) &
        (df["Age"].between(*idade)) &
        (df["Height"].between(*altura)) &
        (df["Weight"].between(*peso)) &
        (df["family_history"].isin(hist_valores)) &
        (df["CAEC"].isin(caec_valores)) &
        (df["FAVC"].isin(favc_valores))
    ]


    st.subheader("Vis√£o Geral")
    col1, col2, col3 = st.columns(3)
    col1.metric("Total de Registros", len(df_filtrado))
    col2.metric("M√©dia de Peso (kg)", f"{df_filtrado['Weight'].mean():.1f}")
    col3.metric("M√©dia de Altura (m)", f"{df_filtrado['Height'].mean():.2f}")

    ordem_obesidade = [
        "Abaixo do Peso", "Peso Normal", "Sobrepeso I",
        "Sobrepeso II", "Obesidade I", "Obesidade II", "Obesidade III"
    ]

    col_dist, col_insight1 = st.columns([3, 2])

    with col_dist:
        st.subheader("Distribui√ß√£o dos N√≠veis de Obesidade")
        dist = df_filtrado["Obesity"].map(rotulos["obesidade_tradutor"])
        dist = pd.Categorical(dist, categories=ordem_obesidade, ordered=True)
        dist = pd.Series(dist).value_counts(normalize=True).reindex(ordem_obesidade).fillna(0).mul(100)
        st.bar_chart(dist)

    with col_insight1:
        with st.expander("üìå Ver Insight"):
            if not dist.empty:
                maior_categoria = dist.idxmax()
                percentual = dist.max()
                st.markdown(f"""
                - A categoria mais comum √© **{maior_categoria}** com **{percentual:.1f}%** dos registros filtrados.
                """)

    aba1, aba2, aba3, aba4, aba5 = st.tabs([
            "üìä Demografia", 
            "üë®‚Äçüë©‚Äçüëß‚Äçüë¶ Hist√≥rico Familiar", 
            "‚öñÔ∏è Altura x Peso", 
            "üèÉ‚Äç‚ôÇÔ∏è Atividade F√≠sica",
            "üçî Comportamento Alimentar"
        ])

    with aba1:
        if df_filtrado.empty:
            st.warning("‚ùå N√£o existem registros para os filtros selecionados.")
        else:
            card1, card2, card3 = st.columns(3)
            card1.metric("M√©dia de Idade", f"{df_filtrado['Age'].mean():.1f} anos")
            card2.metric("Total de Mulheres", len(df_filtrado[df_filtrado["Gender"] == "Female"]))
            card3.metric("Total de Homens", len(df_filtrado[df_filtrado["Gender"] == "Male"]))
            
            col1, col2 = st.columns(2)
            with col1:
                st.subheader("Distribui√ß√£o de Obesidade por G√™nero")
                df_temp1 = df_filtrado.copy()
                df_temp1["Obesity"] = df_temp1["Obesity"].map(rotulos["obesidade_tradutor"])
                df_temp1["Obesity"] = pd.Categorical(df_temp1["Obesity"], categories=ordem_obesidade, ordered=True)
                df_temp1["Gender"] = df_temp1["Gender"].map(rotulos["genero_tradutor"])
                if df_temp1[["Obesity", "Gender"]].dropna().empty:
                    st.info("üîç N√£o existem registros suficientes para gerar este gr√°fico.")
                else:
                    fig1, ax1 = plt.subplots(figsize=(7, 4.5))
                    crosstab = pd.crosstab(df_temp1["Obesity"], df_temp1["Gender"])
                    crosstab = crosstab.reindex(ordem_obesidade, fill_value=0)
                    crosstab.plot(kind='bar', ax=ax1)
                    plt.xticks(rotation=45)
                    plt.tight_layout()
                    st.pyplot(fig1)
            
            with col2:
                st.subheader("Distribui√ß√£o da Idade por Categoria de Obesidade")
                fig_age, ax_age = plt.subplots(figsize=(7, 4.5))
                sns.histplot(data=df_temp1, x="Age", hue="Obesity", multiple="stack", ax=ax_age)
                plt.tight_layout()
                st.pyplot(fig_age)
    
            
            with st.expander("üìå Ver Insight"):
                if df_filtrado[["Obesity", "Gender"]].dropna().empty:
                    st.info("üìå N√£o existem dados dispon√≠veis para gerar insights.")
                else:
                    tabela_percent = pd.crosstab(df_filtrado["Obesity"], df_filtrado["Gender"], normalize='columns') * 100
                    st.dataframe(tabela_percent.round(1))
            
                    total_fem = (df_filtrado["Gender"] == "Female").sum()
                    total_masc = (df_filtrado["Gender"] == "Male").sum()
            
                    if total_fem > 0 and total_masc == 0:
                        st.markdown("""
                        ### üîç Mulheres:
                        - Maior preval√™ncia em **obesidade III**, indicando risco elevado.
                        - H√° tamb√©m concentra√ß√£o significativa nas faixas de **sobrepeso II** e **obesidade I**.
                        - A distribui√ß√£o et√°ria mostra que **a maioria est√° entre 20 e 25 anos**, com casos graves at√© os 40+.
                        """)
                    elif total_masc > 0 and total_fem == 0:
                        st.markdown("""
                        ### üîç Homens:
                        - A maior incid√™ncia est√° em **obesidade II** e **sobrepeso I/II**.
                        - Homens com **peso normal ou abaixo do peso** s√£o menos comuns, indicando tend√™ncia ao excesso de peso.
                        - Idade majorit√°ria entre **18 e 28 anos**, mas tamb√©m h√° obesidade severa acima dos 30.
                        """)
                    else:
                        st.markdown("""
                        ### üîç Geral:
                        - **Homens** concentram-se em **obesidade II** e **sobrepeso**, enquanto **mulheres** apresentam maior n√∫mero em **obesidade III**.
                        - H√° uma distribui√ß√£o consistente de obesidade moderada em ambos os sexos.
                        - A faixa et√°ria predominante √© entre **20 e 25 anos**, indicando uma popula√ß√£o jovem j√° em n√≠veis de obesidade preocupantes.
                        """)




    with aba2:
        
        card_fam1, card_fam2 = st.columns(2)
        hist_sim = df_filtrado[df_filtrado["family_history"] == "yes"]
        card_fam1.metric("Com hist√≥rico familiar", f"{len(hist_sim)} registros")
        card_fam2.metric("Sem hist√≥rico", f"{len(df_filtrado) - len(hist_sim)} registros")

        col_fam1, col_fam2 = st.columns(2)
        with col_fam1:
            st.subheader("Obesidade por Hist√≥rico Familiar")
            df_temp2 = df_filtrado.copy()
            df_temp2["Obesity"] = df_temp2["Obesity"].map(rotulos["obesidade_tradutor"])
            df_temp2["Obesity"] = pd.Categorical(df_temp2["Obesity"], categories=ordem_obesidade, ordered=True)
            df_temp2["family_history"] = df_temp2["family_history"].map(rotulos["historico_tradutor"])
            fig2, ax2 = plt.subplots(figsize=(6, 4.2))
            crosstab2 = pd.crosstab(df_temp2["Obesity"], df_temp2["family_history"])
            crosstab2 = crosstab2.reindex(ordem_obesidade, fill_value=0)
            crosstab2.plot(kind='bar', ax=ax2)
            plt.xticks(rotation=45)
            plt.tight_layout(pad=1.5)
            st.pyplot(fig2)

        with col_fam2:
            st.subheader("Peso vs historico familiar")
            fig_peso_hist, ax_peso_hist = plt.subplots(figsize=(6, 4.2))
            sns.boxplot(data=df_filtrado, x="family_history", y="Weight", ax=ax_peso_hist)
            plt.tight_layout(pad=1.5)
            st.pyplot(fig_peso_hist)

       
        with st.expander("üìå Ver Insight"):
            count_sim = df_filtrado[df_filtrado["family_history"] == "yes"].shape[0]
            count_nao = df_filtrado[df_filtrado["family_history"] == "no"].shape[0]

            if count_sim > 0 and count_nao == 0:
                st.markdown("""
                ### ‚úÖ Apenas com hist√≥rico familiar
                - Indiv√≠duos com **hist√≥rico familiar positivo** apresentam grande incid√™ncia de **obesidade tipo II e III**.
                - Praticamente n√£o h√° registros de **peso normal ou insuficiente** nesse grupo.
                - A mediana de peso √© **significativamente mais alta**, com presen√ßa de **outliers de peso elevado**.
                - Isso pode indicar uma **predisposi√ß√£o gen√©tica relevante**.
                """)

            elif count_nao > 0 and count_sim == 0:
                st.markdown("""
                ### üö´ Apenas sem hist√≥rico familiar
                - Indiv√≠duos **sem hist√≥rico familiar** concentram-se em **peso normal ou sobrepeso I**.
                - A distribui√ß√£o de obesidade severa (tipos II e III) √© praticamente inexistente.
                - O peso tende a ser **mais baixo e est√°vel**, com **menor variabilidade**.
                - Isso sugere que **a aus√™ncia de predisposi√ß√£o gen√©tica pode ser um fator protetivo**.
                """)

            elif count_sim > 0 and count_nao > 0:
                st.markdown("""
                ### üß¨ Comparativo Geral: com vs sem hist√≥rico
                - Indiv√≠duos com **hist√≥rico familiar** de obesidade t√™m **maior propens√£o** a n√≠veis severos de obesidade.
                - A m√©dia e mediana de peso s√£o **notavelmente maiores** nesse grupo.
                - J√° os sem hist√≥rico se concentram mais em **faixas saud√°veis**, com maior percentual de **peso normal**.
                - A **disparidade entre os grupos** refor√ßa a hip√≥tese de que **gen√©tica e ambiente familiar** influenciam fortemente o quadro de obesidade.
                """)

            else:
                st.info("üìå N√£o existem dados dispon√≠veis para gerar insights.")



    with aba3:
        card_hp1, card_hp2 = st.columns(2)
        imc_medio = (df_filtrado["Weight"] / df_filtrado["Height"]**2).mean()
        card_hp1.metric("IMC M√©dio", f"{imc_medio:.1f}")
        card_hp2.metric("Peso M√©dio", f"{df_filtrado['Weight'].mean():.1f} kg")
        
        col_hp1, col_hp2 = st.columns(2)
        with col_hp1:
            st.subheader("Altura vs Peso por Categoria")
            df_temp4 = df_filtrado.copy()
            df_temp4["Obesity"] = df_temp4["Obesity"].map(rotulos["obesidade_tradutor"])
            df_temp4["Obesity"] = pd.Categorical(df_temp4["Obesity"], categories=ordem_obesidade, ordered=True)
            fig4, ax4 = plt.subplots(figsize=(7, 4.5))
            sns.scatterplot(data=df_temp4, x="Height", y="Weight", hue="Obesity", ax=ax4)
            plt.tight_layout()
            st.pyplot(fig4)

        with col_hp2:
            st.subheader("Rela√ß√£o de peso por Categoria de obesidade ")
            fig_boxpeso, ax_boxpeso = plt.subplots(figsize=(7, 4.5))
            sns.boxplot(data=df_temp4, x="Obesity", y="Weight", order=ordem_obesidade, ax=ax_boxpeso)
            plt.xticks(rotation=45)
            plt.tight_layout()
            st.pyplot(fig_boxpeso)

        st.subheader("Rela√ß√£o de Altura por Categoria obesidade")
        fig_boxaltura, ax_boxaltura = plt.subplots(figsize=(7, 4.5))
        sns.boxplot(data=df_temp4, x="Obesity", y="Height", order=ordem_obesidade, ax=ax_boxaltura)
        plt.xticks(rotation=45)
        plt.tight_layout()
        st.pyplot(fig_boxaltura)


        
        with st.expander("üìå Ver Insight"):
            if df_filtrado[["Height", "Weight", "Obesity"]].dropna().empty:
                st.info("üìå N√£o existem dados dispon√≠veis para gerar insights.")
            else:
                imc_medio = df_filtrado["Weight"] / (df_filtrado["Height"] ** 2)
                imc_medio = imc_medio.mean()

                st.markdown(f"""
                ### üìè An√°lise de Altura e Peso (dados Gerais)
                
                - O **IMC m√©dio** da amostra √© de aproximadamente **{imc_medio:.1f}**, o que indica **sobrepeso** segundo a classifica√ß√£o da OMS.
                - A rela√ß√£o entre **altura e peso** mostra que **quanto maior o peso para uma mesma altura**, mais prov√°vel √© a associa√ß√£o com **obesidade severa**.
                - As categorias de **obesidade II e III** apresentam indiv√≠duos com **altos pesos**, independentemente da altura, e muitos est√£o fora dos limites interquartis (outliers).
                - J√° os grupos de **peso normal e abaixo do peso** tendem a se concentrar em alturas m√©dias com pesos significativamente menores.
                - A an√°lise da **altura isolada** por categoria de obesidade mostra uma **leve tend√™ncia de maior altura** nos grupos com obesidade moderada, mas sem grandes diferen√ßas significativas.
                """)

                st.caption("‚ÑπÔ∏è Os gr√°ficos ajudam a identificar padr√µes extremos (outliers) e comportamentos t√≠picos por categoria de obesidade.")


    with aba4:

        pct_sedentarios = (df_filtrado["FAF"] == 0).mean() * 100

        card_faf1, card_faf2 = st.columns(2)
        card_faf1.metric("Sedent√°rios", f"{pct_sedentarios:.1f}%", "FAF = 0")

        pct_ativos = (df_filtrado["FAF"] >= 2).mean() * 100
        card_faf2.metric("Fisicamente Ativos", f"{pct_ativos:.1f}%", "FAF ‚â• 2")

        
        col_faf_grafico, col_faf_insight = st.columns(2)
        with col_faf_grafico:
            st.subheader("Atividade F√≠sica por Categoria de Obesidade")
            df_temp4["Obesity"] = pd.Categorical(df_temp4["Obesity"], categories=ordem_obesidade, ordered=True)
            fig5, ax5 = plt.subplots(figsize=(7, 4.5))
            sns.boxplot(data=df_temp4, x="Obesity", y="FAF", order=ordem_obesidade, ax=ax5)
            plt.xticks(rotation=45)
            plt.tight_layout()
            st.pyplot(fig5)

        with col_faf_insight:
            st.subheader("Distribui√ß√£o do Tempo de Atividade F√≠sica por N√≠vel de Obesidade")
            df_temp_faf = df_filtrado.copy()
            df_temp_faf["Obesity"] = df_temp_faf["Obesity"].map(rotulos["obesidade_tradutor"])
            df_temp_faf["Obesity"] = pd.Categorical(df_temp_faf["Obesity"], categories=ordem_obesidade, ordered=True)

            fig_faf_hist, ax_faf_hist = plt.subplots(figsize=(7, 4.5))
            sns.histplot(
                data=df_temp_faf,
                x="FAF",
                hue="Obesity",
                multiple="fill",
                palette="Set2",
                hue_order=ordem_obesidade,
                edgecolor="black",
                binwidth=0.25
            )
            ax_faf_hist.set_title("Distribui√ß√£o do Tempo de Atividade F√≠sica por N√≠vel de Obesidade")
            ax_faf_hist.set_xlabel("FAF (frequ√™ncia de atividade f√≠sica semanal)")
            ax_faf_hist.set_ylabel("Propor√ß√£o")
            plt.tight_layout()
            st.pyplot(fig_faf_hist)


    
        with st.expander("üìå Ver Insight"):
            if df_filtrado["FAF"].dropna().empty:
                st.info("üìå N√£o existem dados dispon√≠veis para gerar insights.")
            else:
                faf_mean = df_filtrado["FAF"].mean()
                faf_median = df_filtrado["FAF"].median()

                st.markdown(f"""
                ### üèÉ An√°lise de Atividade F√≠sica

                - O valor **m√©dio** da frequ√™ncia de atividade f√≠sica semanal (FAF) √© **{faf_mean:.2f}**, enquanto a **mediana** √© **{faf_median:.2f}** ‚Äî indicando uma **distribui√ß√£o assim√©trica**, com muitas pessoas relatando n√≠veis baixos de atividade.
                - **Indiv√≠duos com obesidade severa (tipo II e III)** tendem a praticar **menos atividade f√≠sica** em compara√ß√£o com os grupos de peso normal ou abaixo do peso.
                - O gr√°fico de propor√ß√£o revela que, mesmo entre aqueles com **alta frequ√™ncia de exerc√≠cios (FAF = 2 ou 3)**, ainda existem casos de **sobrepeso e obesidade**, o que pode indicar influ√™ncia de **outros fatores como alimenta√ß√£o ou gen√©tica**.
                - J√° os grupos com **FAF = 0** apresentam alta concentra√ß√£o de **obesidade tipo III**, refor√ßando a **associa√ß√£o entre sedentarismo e obesidade grave**.
                
                """)
                st.caption("‚ÑπÔ∏è FAF representa a frequ√™ncia de atividade f√≠sica semanal (escala de 0 a 3).")


    with aba5:
        card_freq1, card_freq2, card_freq3 = st.columns(3)
        caec_freq = df_filtrado[df_filtrado["CAEC"] != "no"]
        card_freq1.metric("Faz lanches fora de hora", f"{len(caec_freq)} pessoas")
        card_freq2.metric("Consome comida cal√≥rica", f"{len(df_filtrado[df_filtrado['FAVC'] == 'yes'])} pessoas")
        card_freq3.metric("N√£o consome comida cal√≥rica", f"{len(df_filtrado[df_filtrado['FAVC'] == 'no'])} pessoas")

        df_temp5 = df_filtrado.copy()
        df_temp5["Obesity"] = df_temp5["Obesity"].map(rotulos["obesidade_tradutor"])
        df_temp5["Obesity"] = pd.Categorical(df_temp5["Obesity"], categories=ordem_obesidade, ordered=True)
        df_temp5["CAEC"] = df_temp5["CAEC"].map(rotulos["caec_tradutor"])
        df_temp5["FAVC"] = df_temp5["FAVC"].map(rotulos["favc_tradutor"])

        col_caec, col_favc = st.columns(2)

        with col_caec:
            st.subheader("Obesidade por Frequ√™ncia de Lanches Fora de Hora")
            fig6, ax6 = plt.subplots()
            crosstab5 = pd.crosstab(df_temp5["Obesity"], df_temp5["CAEC"])
            crosstab5 = crosstab5.reindex(ordem_obesidade, fill_value=0)
            crosstab5.plot(kind="bar", ax=ax6)
            plt.xticks(rotation=45)
            st.pyplot(fig6)

        with col_favc:
            st.subheader("Obesidade por Consumo de Comida Cal√≥rica")
            fig7, ax7 = plt.subplots()
            crosstab_favc = pd.crosstab(df_temp5["Obesity"], df_temp5["FAVC"])
            crosstab_favc = crosstab_favc.reindex(ordem_obesidade, fill_value=0)
            crosstab_favc.plot(kind="bar", ax=ax7)
            plt.xticks(rotation=45)
            st.pyplot(fig7)

        with st.expander("üìå Ver Insight"):
            st.markdown("""
            - **Frequ√™ncia alta de lanches fora de hora** (principalmente ‚Äú√Äs vezes‚Äù, ‚ÄúFrequentemente‚Äù e ‚ÄúSempre‚Äù) est√° fortemente associada a maiores n√≠veis de obesidade, especialmente do tipo II e III.
            - O **consumo de comida cal√≥rica** (FAVC = Sim) √© predominante nas categorias de sobrepeso e obesidade ‚Äî praticamente todos os casos graves de obesidade pertencem a esse grupo.
            - Indiv√≠duos que **n√£o consomem comida cal√≥rica** apresentam maior propor√ß√£o de ‚ÄúPeso Normal‚Äù ou ‚ÄúAbaixo do Peso‚Äù, e s√£o minoria nas categorias de obesidade.
            - A **combina√ß√£o de ambos os comportamentos** (lanches fora de hora + consumo de comida cal√≥rica) marca o grupo de maior risco, com alt√≠ssimos n√∫meros em obesidade severa.
            - Estrat√©gias de preven√ß√£o devem focar na **redu√ß√£o do consumo de lanches entre as refei√ß√µes** e no **controle da qualidade dos alimentos**.
            """)

